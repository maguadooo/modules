{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "resourceGroupName": {
            "type": "string",
            "defaultValue": "resourceGroupName",
            "metadata": {
                "description": "description"
            }
        },
        "applicationGatewayName": {
            "type": "string",
            "defaultValue": "applicationGatewayName",
            "metadata": {
                "description": "description"
            }
        },
        "endpointRegistration": {
            "type": "object"
        }
    },
    "variables": {
        "applicationGatewayId": "[concat(subscription().id,'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Network/applicationGateways/',parameters('applicationGatewayName'))]",
        "pathBasedRoutingLength": "[if(
            contains(parameters('endpointRegistration'),'pathBasedRouting'),
            length(parameters('endpointRegistration').pathBasedRouting),
            0
        )]",
        "copy": [
            {
                "name": "pathRules",
                "count": "[variables('pathBasedRoutingLength')]",
                "input": "[
                    if(equals(toLower(parameters('endpointRegistration').pathBasedRouting[copyIndex('pathRules')].type),'backendpool'),
                    createObject(
                        'name',parameters('endpointRegistration').pathBasedRouting[copyIndex('pathRules')].name,
                        'properties',createObject(
                            'backendAddressPool',createObject('id',concat(variables('applicationGatewayId'),'/backendAddressPools/',parameters('endpointRegistration').pathBasedRouting[copyIndex('pathRules')].backendPool)),
                            'backendHttpSettings',createObject('id',concat(variables('applicationGatewayId'),'/backendHttpSettingsCollection/',parameters('endpointRegistration').pathBasedRouting[copyIndex('pathRules')].httpSettings.name)),
                            'paths',parameters('endpointRegistration').pathBasedRouting[copyIndex('pathRules')].paths
                        )
                    ),
                    createObject(
                        'name',parameters('endpointRegistration').pathBasedRouting[copyIndex('pathRules')].name,
                        'properties',createObject(
                            'redirectConfiguration',createObject('id',concat(variables('applicationGatewayId'),'/redirectConfigurations/',parameters('endpointRegistration').pathBasedRouting[copyIndex('pathRules')].name)),
                            'paths',parameters('endpointRegistration').pathBasedRouting[copyIndex('pathRules')].paths
                        )
                    )    
                )]"
            }
        ],
        "urlPathMaps": "[if(
            contains(parameters('endpointRegistration'),'pathBasedRouting'),
            createArray(
                createObject(
                    'name', if(
                        contains(parameters('endpointRegistration'),'routingRule'),
                        concat(parameters('endpointRegistration').routingRule.name),
                        concat(parameters('endpointRegistration').redirectionRule.name)
                    ),
                    'properties', createObject(
                        'pathRules', variables('pathRules'),
                        'defaultBackendAddressPool', if(
                            contains(parameters('endpointRegistration'),'routingRule'),
                            concat(variables('applicationGatewayId'),'/backendAddressPools/',parameters('endpointRegistration').routingRule.backendPool),
                            json('null')
                        ),
                        'defaultBackendHttpSettings', if(
                            contains(parameters('endpointRegistration'),'routingRule'),
                            concat(variables('applicationGatewayId'),'/backendHttpSettingsCollection/',parameters('endpointRegistration').routingRule.httpSettings.name),
                            json('null')
                        ),
                        'defaultRedirectConfiguration', if(
                            contains(parameters('endpointRegistration'),'redirectionRule'),
                            createObject('id',concat(variables('applicationGatewayId'),'/redirectConfigurations/',parameters('endpointRegistration').redirectionRule.name)),
                            json('null')
                        )
                    )
                )
            ),
            createArray()
        )]"
    },
    "resources": [],
    "outputs": {
        "urlPathMaps": {
            "type": "array",
            "value": "[variables('urlPathMaps')]"
        }
    }
}